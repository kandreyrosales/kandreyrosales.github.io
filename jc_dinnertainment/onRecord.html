<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<title>Dinnertainment Invoice</title>
	<script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
	<style>
		.invoice-box table {
			width: 50%;
			line-height: inherit;
			text-align: left;
		}

		.invoice-box table td {
			padding: 5px;
			vertical-align: top;
		}

		.invoice-box table tr td:nth-child(2) {
			text-align: right;
		}

		.invoice-box table tr.top table td {
			padding-bottom: 20px;
		}

		.invoice-box table tr.top table td.title {
			font-size: 45px;
			line-height: 45px;
			color: #333;
		}

		.invoice-box table tr.information table td {
			padding-bottom: 40px;
		}

		.invoice-box table.custom tr td th{
			border-bottom: 1px solid black;
			font-weight: bold;
		}

		.invoice-box table tr.details td {
			padding-bottom: 20px;
		}

		.invoice-box table tr td th{
			border-bottom: 1px solid #eee;
		}

		.invoice-box table tr.total td:nth-child(2) {
			border-top: 2px solid #eee;
			font-weight: bold;
		}

		@media only screen and (max-width: 600px) {
			.invoice-box table tr.top table td {
				width: 100%;
				display: block;
				text-align: center;
			}

			.invoice-box table tr.information table td {
				width: 50%;
				display: block;
				text-align: center;
			}
		}

		.invoice-box.rtl table {
			text-align: right;
		}

		.invoice-box.rtl table tr td:nth-child(2) {
			text-align: left;
		}

		table.custom, td.custom, th.custom {
			border: 1px solid black;
		}

	</style>
</head>

<body>
<div class="invoice-box-2">
	<table cellpadding="0" cellspacing="0">
		<tr class="top">
			<td colspan="2">
				<table>
					<tr>
						<td class="title">
							<img src="logo_dinnertainment.png" style="width: 100%; max-width: 300px" />
						</td>
						<td>
							<b>Invoice #:</b> 123<br />
							<b>Date Booked:</b> January 1, 2015<br />
						</td>
					</tr>
				</table>
			</td>
		</tr>

		<tr class="information">
			<td colspan="2">
				<table>
					<tr>
						<td>
							<b>Name:</b> Kevin Rosales<br />
							<b>Location:</b> Gemelos<br />
							<b>Email:</b> example@gmail.com<br />
							<b>Phone:</b> +57 3182445566<br />
							<b>Allergies & Preferences:</b> None<br />
						</td>
						<td>
							<b>Number of Guests:</b> 12<br />
							<b>Celebrating:</b> Wedding<br />
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
	<table class="custom" id="custom_jc_table" border="1">
		<tr class="custom">
			<th class="custom">Date</th>
			<th class="custom">Arrival Time</th>
			<th class="custom">Service Begins</th>
			<th class="custom">Service Ends</th>
			<th class="custom">Menu</th>
			<th class="custom">Service</th>
			<th class="custom">Guests</th>
			<th class="custom">Price per Person</th>
		</tr>
	</table>
</div>
<script>
	grist.ready();
	function generateTable(table, data) {
		for (element in data) {
			data[element].forEach(function (item, i){
				let row = table.insertRow();

				let date = row.insertCell(0);
				date.innerHTML = new Date(item["Date"]).toDateString();

				let arrival_time = row.insertCell(1);
				arrival_time.innerHTML = new Date(item["Arrival_Time"]).toDateString();

				let service_begins = row.insertCell(2);
				service_begins.innerHTML = new Date(item["Service_Begins2"]).toUTCString();

				let service_ends = row.insertCell(3);
				service_ends.innerHTML = new Date(item["Service_Ends"]).toUTCString();

				let menu_item = row.insertCell(4);
				menu_item.innerHTML = item["Menu_Item_Name"];

				let service = row.insertCell(5);
				service.innerHTML = item["Service_Option"];

				let guest = row.insertCell(6);
				guest.innerHTML = item["Guests"];

				let precio_pp = row.insertCell(7);
				precio_pp.innerHTML = item["Precio_PP"];

			})
		}
	}
	async function main(invoice_number){
		const rows = await grist.docApi.fetchTable("Choices");
		const filtered = get_records(rows).filter(r => r.Invoice_Number === invoice_number);
		const data_grouped_by_date = group_rows_by_date(filtered);
		let table = document.getElementById("custom_jc_table");
		generateTable(table, data_grouped_by_date)
	};
	grist.onRecord(function(record) {
		const invoice_number = record.Invoice_Number;
		const name = record.Name;
		const date_booked = record.Date_Booked;
		main(invoice_number)
	});

	function get_records(rows) {
		// Convert column representation to record representation
		const list = [];
		for(let i=0; i < rows.id.length; i++) {
			const record = {};
			for(const key of Object.keys(rows)) {
				record[key] = rows[key][i];
			}
			list.push(record);
		}
		return list;
	}

	function group_rows_by_date(list_of_array){
		const groupBy = (array, key) => {
			// Return the reduced array
			return array.reduce((result, currentItem) => {
				// If an array already present for key, push it to the array. Otherwise create an array and push the object.
				(result[currentItem[key]] = result[currentItem[key]] || []).push( currentItem );
				// return the current iteration `result` value, this will be the next iteration's `result` value and accumulate
				return result;

			}, {}); // Empty object is the initial value for result object
		};
		return groupBy(list_of_array, "Date")
	}
</script>
</body>

</html>